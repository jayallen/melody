<TMPL_UNLESS NAME=JSON>
<TMPL_INCLUDE NAME="header-dialog.tmpl">

<script type="text/javascript" src="<TMPL_VAR NAME=STATIC_URI>js/tc/client.js"></script>
<script type="text/javascript" src="<TMPL_VAR NAME=STATIC_URI>js/tc/json.js"></script>
<script type="text/javascript" src="<TMPL_VAR NAME=STATIC_URI>js/dialog.js"></script>

<div class="modal_width" id="list-assets-dialog">

<script type="text/javascript">
<!--
var assets = {};

function toggleScrollBar(which) {
    var el = getByID("selector");
    if (which == 'left') {
        TC.addClassName(el, "condensed");
    } else {
        TC.removeClassName(el, "condensed");
    }
}

var opened = false;
var asset_id = '';
function hasOpened(id) { 
    opened = true;
    asset_id = id;    
}

function notOpened(id) { 
    opened = false; 
    asset_id = '';    
}

function checkOpened() {
    if (opened) {
        hide('asset-' + asset_id + '-detail');
        notOpened(asset_id);
        toggleScrollBar('right');
    }
} 

function displayAssetDetails(id) {
    /* display popup panel showing details of selected asset */
    checkOpened();
    hasOpened(id);
    var detail = getByID("asset-" + id + "-detail");
    var detail_inner = getByID("asset-" + id + "-detail-inner-modal");
    var asset = assets[id];
    if (!asset) {
        var detail_json = getByID("asset-" + id + "-json");
        if (!detail_json) return false;
        asset = eval('(' + detail_json.value + ')');
        if (!asset) return false;
        assets[id] = asset;
    }
    var close_link = "<a href=\"javascript:void(0)\" onclick=\"hide('asset-" + id + "-detail'); notOpened('<TMPL_VAR NAME=ID>'); toggleScrollBar('right');\"><MT_TRANS phrase="Close"></a>";
    var close_icon = "<a href=\"javascript:void(0)\" onclick=\"hide('asset-" + id + "-detail'); notOpened('<TMPL_VAR NAME=ID>'); toggleScrollBar('right');\"><img class=\"close_asset_icon\" align=\"bottom\" src=\"<TMPL_VAR NAME=STATIC_URI>images/spacer.gif\" width=\"9\" height=\"9\"></a>";
    var preview;
    if (asset.thumbnail_url) {
        preview = "<img src=\"" + asset.thumbnail_url + "\" class=\"preview\" /><br />";
    } else {
        ext = asset.ext;
        var icons = ("doc,eps,fla,gif,jpg,mp3,mpg,pdf,png,ppt,psd,txt,xls,zip");
        var icon_array = icons.split(",");
        for (var loop=0; loop < icon_array.length; loop++) {
            if (ext == icon_array[loop]){
                asset.ext = ext;
                break;
            } else {
                asset.ext = "default";
            }
        }
        preview = "<div class=\"asset-icon-area\"><div class=\"asset-icon-layout\"><div class=\"asset-icon-" + asset.ext + "\"><img src=\"<TMPL_VAR NAME=STATIC_URI>images/spacer.gif\" width=\"90\" height=\"96\"></div></div></div><b><MT_TRANS phrase="No Preview Available"></b><br /><a href=\"" + asset.url + "\" target=\"view_uploaded\"><MT_TRANS phrase="Click to see uploaded file."></a>";
    }
    var metadata = '';
    var meta_names = [];
    var meta_name;
    for (meta_name in asset) {
        if (meta_name.match(/^[a-z_]/)) continue;
        if (!asset[meta_name]) continue;
        meta_names[meta_names.length] = meta_name;
    }
    meta_names.sort();
    var i;
    for (i = 0; i < meta_names.length; i++) {
        meta_name = meta_names[i];
        metadata += '<dt>' + meta_name + ":</dt> <dd>" + asset[meta_name] + "</dd>";
    }
    iam = asset.name;
    detail_inner.innerHTML = "<div class=\"close_asset_detail\">" + close_link + " " + close_icon + "</div>"
        + "<div class=\"asset-detail-title\">" + iam + "</div>"
        + "<div class=\"asset_detail_left\">" + preview + "</div>"
        + "<div class=\"asset_detail_right\">"
        + "<div class=\"metadata\"><dl>" + metadata + "</dl></div>"
        + "</div>";
    show("asset-" + id + "-detail");
    return false;
}

function viewChange(ds, fn) {
    checkOpened();
    if (fn) fn(ds);
}

function dialogClose(data) {
    if (!data) {
        closeDialog();
        return;
    }
    // user made a selection and clicked insert...
    var f = document.forms['select_asset'];
    var sel = dlg.panel.tableSelect.selected();
    f['id'].value = sel[0].value;
    f.submit();
}

var tableSelect;
var dlg;
function init() {
	// setup
	dlg = new Dialog.Simple("list-assets");
	var panel = new ListingPanel("assets");
	dlg.panel = panel;
	var old_update = panel.datasource.onUpdate;
	panel.datasource.onUpdate = function(ds) { viewChange(ds, old_update) };
	panel.pager.setState(<TMPL_VAR NAME=PAGER_JSON>);
	panel.parent = dlg;
	dlg.open({}, dialogClose);
}
TC.attachLoadEvent( init );
// -->
</script>

<div id="assets-panel" class="panel">

<h2><span class="weblog-title-highlight"><TMPL_IF NAME=EDIT_BLOG_ID><TMPL_VAR NAME=BLOG_NAME ESCAPE=HTML><TMPL_ELSE><MT_TRANS phrase="System-wide"></TMPL_IF>: </span> <MT_TRANS phrase="Assets"></h2>

    <span class="modal_added"><MT_TRANS phrase="Select the image you want to insert, or upload a new one."></span>

<p class="page-desc">
<TMPL_IF NAME=EDIT_BLOG_ID>
<TMPL_IF NAME=CAN_UPLOAD>
<img src="<TMPL_VAR NAME=STATIC_URI>images/status_icons/create.gif" alt="<MT_TRANS phrase="Upload New File">" width="9" height="9" />
<a href="<TMPL_VAR NAME=SCRIPT_URL>?__mode=start_upload&amp;_type=asset&amp;blog_id=<TMPL_VAR NAME=BLOG_ID>&amp;dialog_view=1&amp;entry_insert=1&amp;edit_field=<TMPL_VAR NAME=EDIT_FIELD>&amp;return_args=<TMPL_VAR NAME=RETURN_ARGS ESCAPE=URL>')"><MT_TRANS phrase="Upload New File"></a>
</TMPL_IF>
</TMPL_IF>
</p>

<div class="list-wrapper">
</TMPL_UNLESS>
<TMPL_IF NAME=OBJECT_LOOP><TMPL_UNLESS NAME=JSON>
<form method="post" action="<TMPL_VAR NAME=SCRIPT_URL>" name="select_asset">
<input type="hidden" name="__mode" value="asset_insert" />
<input type="hidden" name="_type" value="asset" />
<input type="hidden" name="return_args" value="<TMPL_VAR NAME=RETURN_ARGS ESCAPE=HTML>" />
<input type="hidden" name="magic_token" value="<TMPL_VAR NAME=MAGIC_TOKEN>" />
<input type="hidden" name="dialog_view" value="1" />
<TMPL_IF NAME=EDIT_BLOG_ID>
<input type="hidden" name="blog_id" value="<TMPL_VAR NAME=EDIT_BLOG_ID>" />
<input type="hidden" name="id" value="" />
<input type="hidden" name="edit_field" value="<TMPL_VAR NAME=EDIT_FIELD>" />
</TMPL_IF>
</form>

<div class="selector list" id="selector">
<form action="" method="get" onsubmit="return false">
<table cellspacing="0" class="list-heading <TMPL_UNLESS NAME=EDIT_BLOG_ID>show-weblog </TMPL_UNLESS><TMPL_IF NAME=VIEW_EXPANDED>expanded<TMPL_ELSE>compact</TMPL_IF>">

<tr>
<th class="cb"><img src="<TMPL_VAR NAME=STATIC_URI>images/spacer.gif" width="15" height="1"></th>
<th id="as-file-status"><img src="<TMPL_VAR NAME=STATIC_URI>images/status_icons/flag.gif" alt="<MT_TRANS phrase="Status">" title="<MT_TRANS phrase="Status">" width="9" height="9" /></th>
<th class="panel-label"><MT_TRANS phrase="Filename"></th>
<TMPL_UNLESS NAME=EDIT_BLOG_ID>
<th id="as-weblog"><MT_TRANS phrase="Weblog"></th>
</TMPL_UNLESS>
<th class="panel-description"><span class="detail"><MT_TRANS phrase="Size"></span></th>
</tr>
</table>

        <div class="list-data-wrapper-modal list-data">
</TMPL_UNLESS>
            <div class="list-data-layout-modal">
            <table cellspacing="0" class="list-data" id="assetDisplay">
<TMPL_LOOP NAME=OBJECT_LOOP>
<tr id="asset-<TMPL_VAR NAME=ID>" class="<TMPL_IF __ODD__>odd<TMPL_ELSE>even</TMPL_IF>">
<td class="cb"><input type="hidden" id="asset-<TMPL_VAR NAME=ID>-json" value="<TMPL_VAR NAME=METADATA_JSON ESCAPE=HTML>" />
<input type="radio" name="id" value="<TMPL_VAR NAME=ID>" class="select" /></td>
<td class="status-<TMPL_IF NAME=FILE_IS_MISSING>missing<TMPL_ELSE>publish</TMPL_IF>"><img src="<TMPL_VAR NAME=STATIC_URI>images/spacer.gif" <TMPL_IF NAME=FILE_IS_MISSING>alt="<MT_TRANS phrase="Pending">"<TMPL_ELSE>alt="<MT_TRANS phrase="Published">"</TMPL_IF> width="9" height="9" /</td>
<td class="panel-label"><span title="<TMPL_VAR NAME=FILE_PATH ESCAPE=HTML>"><TMPL_UNLESS NAME=FILE_IS_MISSING><a href="javascript:void(0)" onclick="displayAssetDetails('<TMPL_VAR NAME=ID>'); toggleScrollBar('left');"></TMPL_UNLESS><TMPL_VAR NAME=FILE_NAME ESCAPE=HTML><TMPL_UNLESS NAME=FILE_IS_MISSING></a></TMPL_UNLESS></span>
<div id="asset-<TMPL_VAR NAME=ID>-detail" class="asset-detail-panel-modal"><div id="asset-<TMPL_VAR NAME=ID>-detail-inner-modal" class="asset-detail-panel-inner-modal"></div></div></td>
<TMPL_UNLESS NAME=EDIT_BLOG_ID>
<td class="detail"><a href="<TMPL_VAR NAME=SCRIPT_URL>?__mode=list_assets&amp;blog_id=<TMPL_VAR NAME=BLOG_ID>"><TMPL_VAR NAME=BLOG_NAME ESCAPE=HTML></a></td>
</TMPL_UNLESS>
            <td class="panel-description"><span class="detail">
            <TMPL_IF NAME=FILE_SIZE_FORMATTED>
            <span class="float_desc" title="<TMPL_VAR NAME=FILE_SIZE>"><TMPL_VAR NAME=FILE_SIZE_FORMATTED></span>
            <TMPL_ELSE>
            <span class="float_desc"><TMPL_VAR NAME=FILE_SIZE></span>
            </TMPL_IF>
            <span class="link">
            <TMPL_IF NAME=URL><a href="<TMPL_VAR NAME=URL>" target="view_uploaded" title="<MT_TRANS phrase="View File">"><img src="<TMPL_VAR NAME=STATIC_URI>images/spacer.gif" alt="<MT_TRANS phrase="View File">" width="13" height="9" /></a><TMPL_ELSE>&nbsp;</TMPL_IF>
            </span></span>
            </td>
</tr>
</TMPL_LOOP>
</table>
</div>
<TMPL_UNLESS NAME=JSON>
</form>
</div>

<div class="pager"></div>

<div class="insert_button_spacing">&nbsp;</div>

<div class="panel-commands">
    <form action="" method="get" onsubmit="return false">
    <input class="cancel" type="button" value="<MT_TRANS phrase="Cancel">" />
    <input class="close" type="submit" value="<MT_TRANS phrase="Insert">" disabled="disabled" />
    </form>
</div>

</TMPL_UNLESS>
<TMPL_ELSE>
<br /><h4 class="message"><MT_TRANS phrase="No assets could be found."></h4>
</TMPL_IF><TMPL_UNLESS NAME=JSON>

</div>

</div>

<TMPL_INCLUDE NAME="footer-dialog.tmpl">
</TMPL_UNLESS>
