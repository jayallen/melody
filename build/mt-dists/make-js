#!/usr/bin/perl -w

use strict;

use lib 'lib';
use lib 'extlib';
use MT;
use MT::Util qw(encode_js);

my $js = `cat mt-static/mt.js`;
$js .= `cat mt-static/js/edit.js`;
$js .= `cat mt-static/js/dialog.js`;
$js .= `cat mt-static/js/assetdetail.js`;
$js .= `cat tmpl/cms/edit_template.tmpl`;
$js .= `cat tmpl/cms/edit_entry.tmpl`;
$js .= `cat tmpl/cms/widget/blog_stats.tmpl`;
$js .= `cat tmpl/cms/list_tag.tmpl`;
$js .= `cat tmpl/cms/include/calendar.tmpl`;

foreach my $lang (qw(ja de nl fr es)) {
    open(FOUT, ">./mt-static/mt_$lang.js")
        or die "failed to open mt-static/mt_$lang.js for writing";

    print FOUT "/* Movable Type language lexicon for $lang localization. */\n\n";

    eval 'require MT::L10N::' . $lang
        or die "failed to find package MT::L10N::$lang";

    my $lex = eval '\%{ %MT::L10N::' . $lang . '::Lexicon }';
    $js =~ s/\\'/\t\t/g;
    while ($js =~ m/trans\((["'])([^\1|\\\1]+?)\1/g) {
        my $str = $2;
        $str =~ s/\t\t/'/g;
        my $local = $lex->{$str} || $str;
        $str = encode_js($str);
        $local = encode_js($local);
        next if $str eq $local;
        print FOUT "Lexicon['$str'] = '$local';\n";
    }
    close(FOUT);
}
