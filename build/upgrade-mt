#!/bin/bash

perl=$5
from=$3
to=$4
db=$1
upgradescript=$2

usage () {
    echo <<EOF
Usage: mt-upgrade <objectdriver> <upgrade-script> [<old-version>] <new-version>
Where <old-version> and <new-version> are directories
      <objectdriver> is an MT::ObjectDriver subclass name (not incl. "MT::"
      and <upgrade-script> is a runnable script.
EOF
}

if [[ ! -d $from || $1 == '' ]]; then
    usage ;
fi

cat >/tmp/config <<EOF
ObjectDriver $db
Database test
DBUser ezra
DataSource /tmp/test-bdb
EOF

if [[ $db == DBI::postgres ]]; then
  echo 'drop database test' | /usr/local/pgsql/bin/psql typepad-ezra typepad
  echo 'create database test' | /usr/local/pgsql/bin/psql typepad-ezra typepad;

elif [[ $db == DBI::mysql ]]; then
  echo 'drop database test' | /usr/local/mysql/bin/mysql -u ezra -p mt_ezra 
  echo 'create database test' | /usr/local/mysql/bin/mysql -u ezra -p mt_ezra;

elif [[ $db == DBI::sqlite ]]; then
  rm test                            # CAVEAT DEVELEPOR

elif [[ $db == DBM ]]; then
  rm /tmp/test-bdb/*

else
  echo "Unrecognized objectdriver $3"
  exit 2;

fi

if [[ $perl == "" ]]; then
    perl=/usr/bin/perl;
else
    $perl -e 'print "using perl version ", $], "\n"';
fi

if [[ ! -d $to ]]; then
  grep -vE 'DBUser|Database|ObjectDriver|DataSource' $from/mt.cfg \
	 | cat - /tmp/config > $from/mt.cfg
  $perl $from/mt-load.cgi;
  cd $from; $perl -Ilib t/test-data.pl;
else
  grep -vE 'DBUser|Database|ObjectDriver|DataSource' $from/mt.cfg \
	 | cat - /tmp/config > $from/mt.cfg
  grep -vE 'DBUser|Database|ObjectDriver|DataSource' $to/mt.cfg \
	 | cat - /tmp/config > $to/mt.cfg
  echo loading $from;
  $perl $from/mt-load.cgi --nostyle;
  echo loading extra data;
#  (cd $from; perl -Ilib t/test-data.pl) && 
  echo *****upgrading $to &&
  $perl $to/$upgradescript
fi
